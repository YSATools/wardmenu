/*jshint strict:true browser:true debug:true jquery:true es5:true onevar:true laxcomma:true laxbreak:true eqeqeq:true immed:true latedef:true unused:true undef:true*/var cache,Join=null,store={},gmembers,gcards,ldsDir,emitter={},ludrsBase="https://www.lds.org/directory/services/ludrs";(function(){"use strict";function e(){this.init()}function t(e,t){function i(){if(0===e.length){n();return}r+=1,t(i,e.shift(),r,e)}var n,r=-1;return setTimeout(i,4),{then:function(e){n=e}}}function r(){}function i(){$("#js-counter").text(1+(Number($("#js-counter").text())||0))}function s(){var e=[],t=ldsDir.wards,n=[];$("#js-counter").length||$("body").prepend('<div style="z-index: 100000; position:fixed;top:40%; width:200px; height:50px;right: 50%; background-color:black;" id="js-counter">0</div>'),t.forEach(function(e){n.push(e.wardUnitNo)}),ldsDir.getWards(function(t){console.log("getWards");var n=[],r;console.log("got wards 9"),t.forEach(function(e){var t=e.householdInfo.email||e.headOfHousehold.email;t&&n.push(t)}),gmembers=t,console.log("got wards a"),t.forEach(function(t){e.push({name:t.headOfHousehold.name,imageData:t.imageData})}),gcards=e,console.log("got wards a.2"),r=prompt("Name this deck (should end with .json)"),/\.json$/.test(r)||(r+=".json",alert("deckId changed to "+r)),console.log("got wards b"),$.ajax({type:"POST",url:"http://LOCATION_HOST/decks/"+r,contentType:"application/json; charset=utf-8",data:JSON.stringify(e),processData:!1,success:function(e){if(!e||!e.success){alert("had error posting deck");return}location.href="http://LOCATION_HOST#"+r}})},[ldsDir.homeWardId]||ldsDir.homeStake.wards)}store.get=function(e){return cache||(cache={}),cache[e]},store.set=function(e,t){cache[e]=t},e.prototype.init=function(){emitter._listeners={}},e.prototype.on=function(e,t){this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(t)},e.prototype.emit=function(){var e=[].slice.call(arguments),t=e.shift();this._listeners[t]=this._listeners[t]||[],this._listeners[t].forEach(function(t){t.apply(null,e)})},Join={create:function(){var e=[],t=Infinity,n,r=0;return{when:function(i){n=i,t=e.length,r===t&&n.apply(null,e)},add:function(){var i=e.length;return e[e.length]=null,function(){var s=[].slice.call(arguments);r+=1,e[i]=s,n&&r===t&&n.apply(null,e)}}}}};var n;n=r.prototype,n.init=function(e){this.areas=null,this.homeArea=null,this.homeAreaId=null,this.stakes=null,this.homeStake=null,this.homeStakeId=null,this.wards=null,this.homeWard=null,this.homeWardId=null,this._listeners=e||{}},n.getHousehold=function(e,t){function s(){store.set(r,i),n._listeners.profile&&n._listeners.profile(i),e(i)}function o(e,t){if(!t.photoUrl){e();return}var n;n=document.createElement("img"),n.onload=function(){var n=document.createElement("canvas"),r=n.getContext("2d");n.height=this.height,n.width=this.width,r.drawImage(this,0,0),t.imageData=n.toDataURL("image/jpeg",.4),e()},n.onerror=function(){e()},n.src=t.photoUrl}var n=this,r="profile-"+t,i=store.get(r);if(i){s(i);return}$.getJSON(ludrsBase+"/mem/householdProfile/"+t,function(e){i=e,i.photoUrl=i.householdInfo.photoUrl||i.headOfHousehold.photoUrl,o(s,i)})},n.getHouseholds=function(e,n){function s(e,t){r.getHousehold(function(t){i.push(t),e()},t)}var r=this,i=[];t(n,s).then(function(){console.log(i),e(i)})},n.getWard=function(e,t){var n=Join.create(),r="member-list-"+t,i=store.get(r);if(i){e(i);return}$.getJSON(ludrsBase+"/mem/member-list/"+t,n.add()),$.getJSON(ludrsBase+"/mem/wardDirectory/photos/"+t,n.add()),n.when(function(n,r){var i=n[0],s=r[0];s.forEach(function(e){i.forEach(function(t){if(e.householdId!==t.headOfHouseIndividualId)return;t.householdId=e.householdId,t.householdName=e.householdName,t.phoneNumber=e.phoneNumber,t.photoUrl=t.photoUrl||e.photoUrl})}),store.set("member-list-"+t,i),e(i)})},n.getWards=function(e,n){function s(e,t){r.getWard(function(t){t.forEach(function(e){i.push(e.headOfHouseIndividualId)}),e()},t)}var r=this,i=[];t(n,s).then(function(){r.getHouseholds(e,i)})},n.getStakeInfo=function(e){function o(){t.homeArea=r,t.homeAreaId=r.areaUnitNo,t.homeStakeId=r.stakeUnitNo,t.homeWardId=r.wardUnitNo,t.stakes=s,t.homeStake=t.stakes[0],t.wards=t.homeStake.wards,e()}var t=this,n="area-info",r=store.get(n),i="stakes-info",s=store.get(i);if(r&&s){o();return}$.getJSON(ludrsBase+"/unit/current-user-ward-stake/",function(e){r=e,store.set(n,e),$.getJSON(ludrsBase+"/unit/current-user-units/",function(e){s=e,store.set(i,s),o()})})},ldsDir=new r,ldsDir.init({profile:i}),ldsDir.getStakeInfo(s)})();